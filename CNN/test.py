import simbench as sb
import pandas as pd
import numpy as np
import warnings
import sys
import inspect

# å°è¯•å¯¼å…¥ VeraGrid
try:
    import GC_PandaPowerImporter
    from VeraGridEngine import api as gce
except ImportError:
    print("âŒ ç¼ºå°‘ VeraGrid ä¾èµ–")
    exit()

warnings.filterwarnings('ignore')

# è¾“å‡ºæ–‡ä»¶
OUTPUT_FILE = "veragrid_api_reference.txt"


class Logger(object):
    def __init__(self):
        self.terminal = sys.stdout
        self.log = open(OUTPUT_FILE, "w", encoding='utf-8')

    def write(self, message):
        self.terminal.write(message)
        self.log.write(message)

    def flush(self):
        pass


def inspect_obj(obj_name, obj, show_values=True):
    print(f"\n{'=' * 60}")
    print(f"ğŸ“¦ OBJECT CLASS: {obj_name}")
    print(f"   Type: {type(obj)}")
    print(f"{'=' * 60}")

    # è·å–æ‰€æœ‰éé­”æ³•å±æ€§
    attrs = [a for a in dir(obj) if not a.startswith('__')]
    attrs.sort()

    print(f"{'Attribute Name':<35} | {'Type':<20} | {'Current Value (Example)'}")
    print("-" * 90)

    for attr in attrs:
        try:
            val = getattr(obj, attr)
            val_type = type(val).__name__

            # è·³è¿‡æ–¹æ³•(Method)ï¼Œåªçœ‹å±æ€§(Property/Data)
            if inspect.ismethod(val) or inspect.isfunction(val):
                continue

            val_str = str(val)
            if len(val_str) > 50: val_str = val_str[:47] + "..."

            # ç‰¹æ®Šå¤„ç† Enumï¼Œé˜²æ­¢æŠ¥é”™
            if "Enum" in val_type or "int" in val_type:
                try:
                    if hasattr(val, 'value'): val_str = f"Enum({val.value})"
                except:
                    pass

            print(f".{attr:<34} | {val_type:<20} | {val_str}")
        except Exception as e:
            print(f".{attr:<34} | {'Error':<20} | {e}")


def main():
    # é‡å®šå‘è¾“å‡ºåˆ°æ–‡ä»¶
    sys.stdout = Logger()

    print(f"ğŸš€ å¼€å§‹ç”Ÿæˆ VeraGrid API å‚è€ƒæ‰‹å†Œ...")
    print(f"ğŸ“… Generated by script. Target: VeraGrid/GridCal internal structure inspection.\n")

    # 1. åŠ è½½æ¨¡å‹
    sb_code = "1-MV-urban--0-sw"
    net_pp = sb.get_simbench_net(sb_code)
    grid = GC_PandaPowerImporter.PP2GC(net_pp)

    print(f"âœ… æ¨¡å‹åŠ è½½æˆåŠŸ: {sb_code}")

    # ==========================================
    # 1. æ ¸å¿ƒç»„ä»¶è§£å‰–
    # ==========================================
    print("\n\n" + "#" * 60)
    print("PART 1: æ ¸å¿ƒç”µç½‘ç»„ä»¶ (Components)")
    print("#" * 60)

    # Bus
    if len(grid.buses) > 0:
        inspect_obj("Bus (èŠ‚ç‚¹)", grid.buses[0])

    # Generator (é‡ç‚¹ï¼)
    # æ‰¾ä¸€ä¸ª sgenï¼Œå†æ‰¾ä¸€ä¸ª ext_grid
    sgen = next((g for g in grid.generators if "sgen" in getattr(g, 'name', '')), None)
    ext_grid = next((g for g in grid.generators if "Ext_Grid" in getattr(g, 'name', '')), None)

    if sgen: inspect_obj("Generator (åˆ†å¸ƒå¼å…‰ä¼)", sgen)
    if ext_grid: inspect_obj("Generator (å¹³è¡¡èŠ‚ç‚¹/å¤–ç½‘)", ext_grid)

    # Load
    if len(grid.loads) > 0:
        inspect_obj("Load (è´Ÿè·)", grid.loads[0])

    # Line
    lines = getattr(grid, 'lines', [])
    if len(lines) > 0:
        inspect_obj("Line (çº¿è·¯)", lines[0])

    # Transformer
    trafos = getattr(grid, 'transformers', [])
    if len(trafos) > 0:
        inspect_obj("Transformer (å˜å‹å™¨)", trafos[0])

    # ==========================================
    # 2. æ±‚è§£å™¨é…ç½®è§£å‰–
    # ==========================================
    print("\n\n" + "#" * 60)
    print("PART 2: æ±‚è§£å™¨é…ç½® (Solver Options)")
    print("#" * 60)

    try:
        # å°è¯•åˆ›å»ºä¸€ä¸ª AC æ±‚è§£å™¨é€‰é¡¹
        opts = gce.PowerFlowOptions(gce.SolverType.NR)
        inspect_obj("PowerFlowOptions (Newton-Raphson)", opts)
    except:
        print("âŒ æ— æ³•åˆ›å»ºé»˜è®¤ PowerFlowOptions")

    # ==========================================
    # 3. ç»“æœå¯¹è±¡è§£å‰–
    # ==========================================
    print("\n\n" + "#" * 60)
    print("PART 3: è®¡ç®—ç»“æœ (Results)")
    print("#" * 60)

    try:
        # è·‘ä¸€æ¬¡ç®€å•çš„ PF
        driver = gce.PowerFlowDriver(grid, opts)
        driver.run()

        if driver.results:
            inspect_obj("PowerFlowResults", driver.results)

            # é¡ºä¾¿æ‰“å°ä¸€ä¸‹å…³é”®æ•°ç»„çš„å½¢çŠ¶ï¼Œæ–¹ä¾¿ç†è§£
            print("\n[å…³é”®æ•°æ®ç»´åº¦æ£€æŸ¥]:")
            res = driver.results
            if hasattr(res, 'voltage'): print(f"  voltage.shape: {np.shape(res.voltage)}")
            if hasattr(res, 'Sbus'): print(f"  Sbus.shape:    {np.shape(res.Sbus)}")
            if hasattr(res, 'loading'): print(f"  loading.shape: {np.shape(res.loading)}")

    except Exception as e:
        print(f"âŒ è¿è¡Œ PF å¤±è´¥: {e}")

    print("\n\nâœ… å®Œæˆï¼è¯·æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹çš„ veragrid_api_reference.txt")


if __name__ == "__main__":
    main()